// ===== FRONT-END CONFIG (DISPLAY ONLY) =====
const PAYBILL_DISPLAY = "222111"; // shown to users only
const ALERT_PHONE_DISPLAY = "0710181624"; // shown in UI only

// ===== NAVIGATION BETWEEN VIEWS =====
const views = document.querySelectorAll(".view");
const navItems = document.querySelectorAll(".nav-item");
const pageTitle = document.getElementById("pageTitle");
const pageSubtitle = document.getElementById("pageSubtitle");

navItems.forEach((btn) => {
  btn.addEventListener("click", () => {
    const target = btn.dataset.view;
    // update active nav
    navItems.forEach((b) => b.classList.remove("active"));
    btn.classList.add("active");
    // update view
    views.forEach((view) => {
      view.classList.toggle("active-view", view.id === target);
    });
    // header text
    switch (target) {
      case "dashboardView":
        pageTitle.textContent = "Dashboard";
        pageSubtitle.textContent =
          "Live view of rent collection across all 25 buildings.";
        break;
      case "buildingsView":
        pageTitle.textContent = "Buildings";
        pageSubtitle.textContent =
          "Monitor performance per building and per unit.";
        break;
      case "tenantsView":
        pageTitle.textContent = "Tenants";
        pageSubtitle.textContent =
          "Search tenants and review individual balances.";
        break;
      case "paymentsView":
        pageTitle.textContent = "Payments";
        pageSubtitle.textContent =
          "All payments posted from Paybill " + PAYBILL_DISPLAY + ".";
        break;
      case "settingsView":
        pageTitle.textContent = "Settings";
        pageSubtitle.textContent =
          "Integration details for Family Bank & notifications.";
        break;
    }
  });
});

// ===== SIMPLE DATA LOADERS (PLACEHOLDER API CALLS) =====
// In production, these fetch from your backend.
// For now, they use demo JSON to show how it will work.

async function loadDashboard() {
  // Replace with: const res = await fetch('/api/dashboard');
  // const data = await res.json();
  const data = {
    buildings: 25,
    tenants: 375,
    due: 375 * 15000,
    collected: 375 * 15000 * 0.8,
    arrearsByBuilding: [
      { building: "Building 1", arrears: 60000 },
      { building: "Building 5", arrears: 45000 },
      { building: "Building 3", arrears: 30000 }
    ],
    latestPayments: [
      {
        datetime: "2025-12-10 20:30",
        tenant: "Tenant 120",
        unit: "B08-U05",
        amount: 15000,
        source: "M-Pesa → Paybill 222111"
      },
      {
        datetime: "2025-12-10 20:12",
        tenant: "Tenant 34",
        unit: "B03-U04",
        amount: 8000,
        source: "M-Pesa (partial)"
      }
    ]
  };

  document.getElementById("dashBuildings").textContent = data.buildings;
  document.getElementById("dashTenants").textContent = data.tenants;
  document.getElementById("dashDue").textContent =
    data.due.toLocaleString("en-KE");
  document.getElementById("dashCollected").textContent =
    data.collected.toLocaleString("en-KE");

  const arrearsList = document.getElementById("arrearsList");
  arrearsList.innerHTML = "";
  data.arrearsByBuilding.forEach((b) => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <span>${b.building}</span>
      <span style="color:#fecaca;">KES ${b.arrears.toLocaleString(
        "en-KE"
      )}</span>
    `;
    arrearsList.appendChild(div);
  });

  const latestTbody = document.getElementById("latestPaymentsBody");
  latestTbody.innerHTML = "";
  data.latestPayments.forEach((p) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.datetime}</td>
      <td>${p.tenant}</td>
      <td>${p.unit}</td>
      <td>${p.amount.toLocaleString("en-KE")}</td>
      <td>${p.source}</td>
    `;
    latestTbody.appendChild(tr);
  });
}

async function loadBuildings() {
  // Replace with: const res = await fetch('/api/buildings');
  // const data = await res.json();
  const data = Array.from({ length: 25 }, (_, i) => ({
    id: i + 1,
    name: "Building " + (i + 1),
    occupiedUnits: 15,
    totalUnits: 15,
    arrears: Math.floor(Math.random() * 80000)
  }));

  const list = document.getElementById("buildingsList");
  list.innerHTML = "";
  data.forEach((b) => {
    const btn = document.createElement("button");
    btn.className = "list-item";
    btn.innerHTML = `
      <span>${b.name}</span>
      <span style="font-size:11px;color:var(--muted);">
        ${b.occupiedUnits}/${b.totalUnits} units · Arrears
        <span style="color:#fecaca;">KES ${b.arrears.toLocaleString(
          "en-KE"
        )}</span>
      </span>
    `;
    btn.addEventListener("click", () => loadUnitsForBuilding(b.id, b.name));
    list.appendChild(btn);
  });
}

async function loadUnitsForBuilding(buildingId, buildingName) {
  document.getElementById(
    "unitsSubtitle"
  ).textContent = `Units for ${buildingName}`;
  const unitsGrid = document.getElementById("unitsGrid");
  unitsGrid.innerHTML = "";

  // Replace with: const res = await fetch(`/api/buildings/${buildingId}/units`);
  // const units = await res.json();
  const units = Array.from({ length: 15 }, (_, i) => {
    const statusRoll = Math.random();
    let status = "Paid";
    let balance = 0;
    if (statusRoll < 0.2) {
      status = "Due";
      balance = 15000;
    } else if (statusRoll < 0.4) {
      status = "Partial";
      balance = 7500;
    }
    return {
      code: `B${String(buildingId).padStart(2, "0")}-U${String(
        i + 1
      ).padStart(2, "0")}`,
      tenant: "Tenant " + ((buildingId - 1) * 15 + (i + 1)),
      status,
      balance
    };
  });

  units.forEach((u) => {
    const div = document.createElement("div");
    div.className = "unit-pill";
    const statusClass =
      u.status === "Paid"
        ? "status-paid"
        : u.status === "Partial"
        ? "status-partial"
        : "status-due";
    div.innerHTML = `
      <div>
        <div>${u.code}</div>
        <div style="font-size:10px;color:var(--muted);">${u.tenant}</div>
      </div>
      <div class="status-dot ${statusClass}"></div>
    `;
    unitsGrid.appendChild(div);
  });
}

async function loadTenants() {
  // Replace with: const res = await fetch('/api/tenants');
  // const tenants = await res.json();
  const tenants = Array.from({ length: 40 }, (_, i) => ({
    name: "Tenant " + (i + 1),
    building: "Building " + (Math.floor(i / 15) + 1),
    unit: `U${String((i % 15) + 1).padStart(2, "0")}`,
    balance: Math.random() < 0.7 ? 0 : 15000,
    status: Math.random() < 0.7 ? "OK" : "In arrears"
  }));

  const tbody = document.getElementById("tenantsTableBody");
  tbody.innerHTML = "";
  tenants.forEach((t) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${t.name}</td>
      <td>${t.building}</td>
      <td>${t.unit}</td>
      <td>${t.balance.toLocaleString("en-KE")}</td>
      <td>${t.status}</td>
    `;
    tbody.appendChild(tr);
  });

  const search = document.getElementById("tenantSearch");
  search.addEventListener("input", () => {
    const q = search.value.toLowerCase();
    Array.from(tbody.children).forEach((row) => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(q) ? "" : "none";
    });
  });
}

async function loadPayments() {
  // Replace with: const res = await fetch('/api/payments');
  // const payments = await res.json();
  const now = new Date();
  const payments = [
    {
      datetime: now.toISOString().slice(0, 16).replace("T", " "),
      tenant: "Tenant 10",
      unit: "B01-U10",
      amount: 15000,
      channel: "M-Pesa → Paybill 222111"
    },
    {
      datetime: "2025-12-09 18:20",
      tenant: "Tenant 25",
      unit: "B02-U10",
      amount: 8000,
      channel: "M-Pesa (partial)"
    }
  ];

  const tbody = document.getElementById("paymentsTableBody");
  tbody.innerHTML = "";
  payments.forEach((p) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.datetime}</td>
      <td>${p.tenant}</td>
      <td>${p.unit}</td>
      <td>${p.amount.toLocaleString("en-KE")}</td>
      <td>${p.channel}</td>
    `;
    tbody.appendChild(tr);
  });

  document
    .getElementById("paymentsFilter")
    .addEventListener("change", () => loadPayments());
}

// ===== SIMULATE WEBHOOK (DEMO ONLY) =====
// In production: Family Bank / gateway sends POST to your backend,
// backend stores payment, then dashboard reloads data.

document
  .getElementById("btnSimulateWebhook")
  .addEventListener("click", async () => {
    alert(
      "In a real system, this button is not needed.\n" +
        "Family Bank / M-Pesa would send your backend a payment notification " +
        "for Paybill 222111, and the backend would update balances automatically."
    );
    await loadDashboard();
    await loadPayments();
  });

// ===== GLOBAL REFRESH =====
document.getElementById("btnRefresh").addEventListener("click", async () => {
  await loadDashboard();
  await loadBuildings();
  await loadTenants();
  await loadPayments();
});

// ===== INITIAL BOOT =====
(async function init() {
  await loadDashboard();
  await loadBuildings();
  await loadTenants();
  await loadPayments();
})();
